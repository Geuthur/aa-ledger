{% load sri %}
{% load i18n %}

{% include 'bundles/datatables-js-bs5.html' %}
{% include 'bundles/moment-js.html' with locale=True %}
{% sri_static 'ledger/js/charts.js' %}
{% sri_static 'ledger/js/modal/modal-system.js' %}

{% sri_static 'ledger/libs/amCharts/5.14.4/js/index.js' %}
{% sri_static 'ledger/libs/amCharts/5.14.4/js/xy.js' %}
{% sri_static 'ledger/libs/amCharts/5.14.4/js/percent.js' %}
{% sri_static 'ledger/libs/amCharts/5.14.4/js/flow.js' %}

{% sri_static 'ledger/libs/amCharts/5.14.4/js/themes/Animated.js' %}
{% sri_static 'ledger/libs/amCharts/5.14.4/js/themes/Dark.js' %}

<script>
    // Initialize dropdowns on page load
    document.addEventListener('DOMContentLoaded', function() {
        const BillboardData = {{ billboard|default:"null"|safe }};
        initCharts(BillboardData);

        // Table ID
        const corporationTable = $('#ratting')

        /**
        * DataTable for Character Ledger
        * @type {*|jQuery}
        */
        const corporationDataTable = new DataTable(corporationTable, {
                language: aaLedgerSettings.dataTables.language,
                layout: aaLedgerSettings.dataTables.layout,
                ordering: aaLedgerSettings.dataTables.ordering,
                columnControl: aaLedgerSettings.dataTables.columnControl,
                order: [[1, "desc"]],
                columnDefs: [
                    {
                        orderable: false,
                        targets: 6
                    },
                    {
                        type: "num",
                        targets: [1, 2, 3, 4, 5]
                    },
                    {
                        targets: [1, 2, 3, 4],
                        render: function (data, type, row, meta) {
                            // Remove ISK and thousands separator for sorting
                            if (type === 'sort' || type === 'type') {
                                if (typeof data === 'string') {
                                    return parseFloat(data.replace(/[^\d\-\.]/g, '')) || 0;
                                }
                                return data;
                            }
                            return data;
                        }
                    },
                    {
                        targets: 5, // Total column
                        render: function (data, type, row, meta) {
                            if (type === 'sort' || type === 'type') {
                                if (typeof data === 'string') {
                                    // Extrahiere Zahl inkl. Minuszeichen am Anfang, robust gegen Leerzeichen
                                    let match = data.match(/-?\d[\d.,]*/);
                                    if (match) {
                                        // Ersetze Kommas durch nichts, Punkte durch Dezimalpunkt
                                        let num = match[0].replace(/\./g, '').replace(/,/g, '.');
                                        return parseFloat(num) || 0;
                                    }
                                    return 0;
                                }
                                return data;
                            }
                            return data;
                        }
                    }
                ],
                initComplete: function() {
                    _bootstrapTooltip({selector: '#ratting'});
                },
                drawCallback: function () {
                    _bootstrapTooltip({selector: '#ratting'});
                },
            }
        );
    });
</script>
